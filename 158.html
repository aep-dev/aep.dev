<!DOCTYPE html>
<html lang="en-US" class="glue-flexbox">
  <head>
    <title>AEP-158: Pagination</title>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,maximum-scale=2">
    <link href="//fonts.googleapis.com/css?family=Roboto:100,300,400,500,700|Google+Sans:400,500|Product+Sans:400&amp;lang=en" rel="stylesheet"></link>
    <link rel="shortcut icon" href="/assets/favicon.ico">
    <link rel="stylesheet" type="text/css" media="screen" href="//www.gstatic.com/glue/v22_1/glue.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="/assets/css/style.css?v=4f5edfa5">
    <link rel="stylesheet" type="text/css" media="print" href="/assets/css/print.css?v=4f5edfa5">
    <script type="text/javascript" src="//code.jquery.com/jquery-3.4.0.min.js"></script>
    <script type="text/javascript" src="//www.gstatic.com/glue/latest/glue-detect.min.js"></script>
    <script type="text/javascript">
      $('html').css('visibility', 'hidden');
      $.when($.ready).then(() => {
        $('html').css('visibility', 'visible');
      });
    </script>
    <script type="text/javascript" src="/assets/js/global.js?v=4f5edfa5"></script>
    
<script type="text/javascript" src="/assets/js/syntax.js"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-140054909-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-140054909-1');
    </script>
  </head>
  <body>
    <!-- prettier-ignore -->
<header class="glue-header glue-header--single">
  <div class="glue-header__bar glue-header__bar--desktop glue-header__drawer">
    <div class="glue-header__tier">
      <!-- LOCK up-->
      <div class="glue-header__container">
        <div class="glue-header__lock-up">
          <div class="glue-header__logo">
            <a class="glue-header__logo-link" href="/" title="Google">
              <div class="glue-header__logo-container">
                <svg role="img" aria-hidden="true" class="glue-header__logo-svg">
                <!--<use xlink:href="/assets/images/glue-icons.svg#google-color-logo"></use>-->
                </svg>
              </div>
              <p class="glue-header__logo--product">AEPs</p>
            </a>
          </div>
          <a href="#page-content" class="glue-header__skip-content">
            <p class="glue-header__skip-content-text">Jump to Content</p>
          </a>
        </div>
      </div>
      <!-- LINK BAR-->
      <div class="glue-header__container glue-header__container--flex-auto">
        <nav class="glue-header__link-bar">
          <ul id="list-1" class="glue-header__list">
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/general" aria-level="1">Browse AEPs</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/contributing" aria-level="1">Contributing</a>
                </li>
              
            
          </ul>
        </nav>
      </div>
      <!-- CTA-->
      <div class="glue-header__container glue-header__container--cta">
        <div class="glue-header__cta">
        <div class="glue-sitesearch">
          <form method="GET" action="/search">
          <label for="q">Search this site</label>
          <input class="glue-sitesearch__input" type="text" name="q" id="q"
            placeholder="Search AEPs">
          <button type="submit" class="glue-button glue-sitesearch__submit" title="Submit">
            <svg role="img" class="glue-icon glue-icon--24px">
            <use xlink:href="/assets/images/glue-icons.svg#search"></use>
            </svg>
          </button>
          </form>
        </div>
        <a href="https://github.com/aep-dev/aep.dev" target="_blank" class="glue-button glue-button--high-emphasis">
          <img src="/assets/images/github.png" class="github-logo">
          View on GitHub
        </a>
        </div>
      </div>
    </div>
  </div>
  <!-- Mobile header placeholder -->
  <div class="glue-header__bar glue-header__bar--mobile">
    <div class="glue-header__tier">
      <!-- LOCK up-->
      <div class="glue-header__container">
        <div class="glue-header__lock-up">
          <div class="glue-header__hamburger glue-header__hamburger--first-tier">
            <div class="glue-header__hamburger-wrapper">
              <button type="button" class="glue-header__drawer-toggle-btn"
                aria-controls="drawer" aria-expanded="false" aria-label="Open the navigation drawer">
                <svg role="img" class="glue-icon glue-icon--24px"><use xlink:href="/assets/images/glue-icons.svg#menu"></use></svg>
              </button>
            </div>
          </div>
          <div class="glue-header__logo">
            <a class="glue-header__logo-link" href="/" title="Google">
              <div class="glue-header__logo-container">
                <svg role="img" aria-hidden="true" class="glue-header__logo-svg">
                  <!--<use xlink:href="/assets/images/glue-icons.svg#google-color-logo"></use>-->
                </svg>
              </div>
              <p class="glue-header__logo--product">AEPs</p>
            </a>
          </div>
          <!-- SKIP -->
          <a href="#page-content" class="glue-header__skip-content">
            <p class="glue-header__skip-content-text">Jump to Content</p>
          </a>
        </div>
      </div>
      <!-- CTA -->
      <div class="glue-header__container">
        <div class="glue-header__cta">
        <a href="https://github.com/aep-dev/aep.dev" class="glue-button glue-button--high-emphasis">
          <img src="/assets/images/github.png" class="github-logo">
          View on GitHub
        </a>
        </div>
      </div>
    </div>
  </div>
  <div class="glue-header__drawer-backdrop"></div>
</header>
    <div class="glue-page">
      
      <main role="main" id="page-content">
        
<nav id="aep-nav" class="docs-component-nav">
  <ul class="nav-list">
    <li class="nav-item nav-item-header">AEPs by Scope</li>
    <li class="nav-item">
      <a href="/general">General</a>
    </li>
    <li class="nav-item nav-item-header">AEPs</li>
    <li class="nav-item">Meta</li>
      <li class="nav-item">
          <a href="/1">
            <span class="aep-number">1</span>
            AEP Purpose and Guidelines
          </a>
        </li>
      <li class="nav-item">
          <a href="/2">
            <span class="aep-number">2</span>
            AEP Numbering and Organization
          </a>
        </li>
      <li class="nav-item">Resources</li>
      <li class="nav-item">
          <a href="/122">
            <span class="aep-number">122</span>
            Resource paths
          </a>
        </li>
      <li class="nav-item">
          <a href="/126">
            <span class="aep-number">126</span>
            Enumerations
          </a>
        </li>
      <li class="nav-item">Standard Methods</li>
      <li class="nav-item">
          <a href="/131">
            <span class="aep-number">131</span>
            GET for individual resources
          </a>
        </li>
      <li class="nav-item">
          <a href="/151">
            <span class="aep-number">151</span>
            Long-running requests
          </a>
        </li>
      <li class="nav-item">
          <a href="/136">
            <span class="aep-number">136</span>
            Custom operations
          </a>
        </li>
      <li class="nav-item">Fields</li>
      <li class="nav-item">
          <a href="/141">
            <span class="aep-number">141</span>
            Quantities
          </a>
        </li>
      <li class="nav-item">
          <a href="/142">
            <span class="aep-number">142</span>
            Time and duration
          </a>
        </li>
      <li class="nav-item">
          <a href="/144">
            <span class="aep-number">144</span>
            Array fields
          </a>
        </li>
      <li class="nav-item">
          <a href="/145">
            <span class="aep-number">145</span>
            Ranges
          </a>
        </li>
      <li class="nav-item">Fields</li>
      <li class="nav-item">
          <a href="/132">
            <span class="aep-number">132</span>
            GET for collections
          </a>
        </li>
      <li class="nav-item">
          <a href="/154">
            <span class="aep-number">154</span>
            Resource freshness validation
          </a>
        </li>
      <li class="nav-item nav-item-active">
          <a href="/158">
            <span class="aep-number">158</span>
            Pagination
          </a>
        </li>
      <li class="nav-item">Design Patterns</li>
      <li class="nav-item">
          <a href="/164">
            <span class="aep-number">164</span>
            Soft delete
          </a>
        </li>
      <li class="nav-item">
          <a href="/210">
            <span class="aep-number">210</span>
            Unicode
          </a>
        </li>
      <li class="nav-item">
          <a href="/211">
            <span class="aep-number">211</span>
            Authorization checks
          </a>
        </li>
      </ul>
</nav>
<section id="jump-content">
          
<aside id="aep-sidebar" class="docs-component-sidebar">
  <table id="aep-summary">
    <tr><th colspan="2">Pagination</th></tr>
    <tr><td>Number</td><td>158</td></tr>
    <tr><td>Permalink</td><td><a href="https://aep.dev/158">aep.dev/158</a></td></tr>
    <tr><td>State</td><td>Approved</td></tr>
    <tr><td>Created</td><td>2019-02-18</td></tr>
    <tr><td>Updated</td><td>2019-02-18</td></tr>
  </table>

  <section id="aep-toc" class="docs-component-sidebar-toc">
    <div class="toc"><span class="toctitle">Contents</span><ul>
<li><a href="#guidance">Guidance</a><ul>
<li><a href="#skipping-results">Skipping results</a></li>
<li><a href="#opacity">Opacity</a></li>
<li><a href="#expiring-page-tokens">Expiring page tokens</a></li>
<li><a href="#consistency">Consistency</a></li>
<li><a href="#backwards-compatibility">Backwards compatibility</a></li>
</ul>
</li>
<li><a href="#implementation">Implementation</a></li>
</ul>
</div>

  </section>

  <section class="docs-component-sidebar-actions">
    <ul>
      <li><a href="https://github.com/aep-dev/aep.dev/issues/">File Bug</a></li>
      <li><a href="https://github.com/aep-dev/aep.dev/blob/master/aep/general/0158">View source</a></li>
      <li><a href="https://github.com/aep-dev/aep.dev/edit/master/aep/general/0158">Edit this page</a></li>
    </ul>
  </section>
</aside>
<section id="aep-main" class="docs-component-main">
  <section class="section-breadcrumbs">
  <nav
    class="glue-breadcrumbs glue-mod-mt-std glue-mod-mb-std"
    aria-label="You are here."
  >
    <ol class="glue-breadcrumbs__list aep-breadcrumbs">
      <li class="glue-breadcrumbs__item" aria-level="1">
        <a class="glue-breadcrumbs__link" href="/">
          API Enhancement Proposals
        </a>
      </li>
      
      <li class="glue-breadcrumbs__item" aria-level="2">
        <a class="glue-breadcrumbs__link" href="/general">
          General AEPs
        </a>
      </li>
      
      <li class="glue-breadcrumbs__item glue-breadcrumbs__item--active"
          aria-level="3">
        Pagination
      </li>
    </ol>
  </nav>
</section>
  
  <h4 class="aep-number">AEP-158</h4>
  <h1 id="pagination">Pagination</h1>
<p>APIs often need to provide collections of data, most commonly in the
[List][aip-132] standard method. However, collections can often be arbitrarily
sized, and also often grow over time, increasing lookup time as well as the
size of the responses being sent over the wire. Therefore, it is important that
collections be paginated.</p>
<h2 id="guidance">Guidance</h2>
<p>Operations returning collections of data <strong>must</strong> provide pagination <em>at the
outset</em>, as it is a <a href="#backwards-compatibility">backwards-incompatible change</a>
to add pagination to an existing method.</p>
<div class="highlight language-typescript"><pre><span></span><code><span class="c1">// The request structure for listing books.</span><span class="w"></span>
<span class="kd">interface</span><span class="w"> </span><span class="nx">ListBooksRequest</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// The parent, which owns this collection of books.</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Format: publishers/{publisher}</span><span class="w"></span>
<span class="w">  </span><span class="nx">parent</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// The maximum number of books to return. The service may return fewer than</span><span class="w"></span>
<span class="w">  </span><span class="c1">// this value.</span><span class="w"></span>
<span class="w">  </span><span class="c1">// If unspecified, at most 50 books will be returned.</span><span class="w"></span>
<span class="w">  </span><span class="c1">// The maximum value is 1000; values above 1000 will be coerced to 1000.</span><span class="w"></span>
<span class="w">  </span><span class="nx">maxPageSize</span><span class="o">:</span><span class="w"> </span><span class="kt">bigint</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// A page token, received from a previous `ListBooks` call.</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Provide this to retrieve the subsequent page.</span><span class="w"></span>
<span class="w">  </span><span class="c1">//</span><span class="w"></span>
<span class="w">  </span><span class="c1">// When paginating, all other parameters provided to `ListBooks` must match</span><span class="w"></span>
<span class="w">  </span><span class="c1">// the call that provided the page token.</span><span class="w"></span>
<span class="w">  </span><span class="nx">pageToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// The response structure from listing books.</span><span class="w"></span>
<span class="kd">interface</span><span class="w"> </span><span class="nx">ListBooksResponse</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// The books from the specified publisher.</span><span class="w"></span>
<span class="w">  </span><span class="nx">books</span><span class="o">:</span><span class="w"> </span><span class="kt">Book</span><span class="p">[];</span><span class="w"></span>

<span class="w">  </span><span class="c1">// A token that can be sent as `page_token` to retrieve the next page.</span><span class="w"></span>
<span class="w">  </span><span class="c1">// If this field is omitted, there are no subsequent pages.</span><span class="w"></span>
<span class="w">  </span><span class="nx">nextPageToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>Request definitions for collections <strong>should</strong> define an
  <code>int32 max_page_size</code> field, allowing users to specify the maximum number of
  results to return.<ul>
<li>If the user does not specify <code>max_page_size</code> (or specifies <code>0</code>), the API
  chooses an appropriate default, which the API <strong>should</strong> document. The API
  <strong>must not</strong> return an error.</li>
<li>If the user specifies <code>max_page_size</code> greater than the maximum permitted by
  the service, the service <strong>should</strong> coerce down to the maximum permitted
  page size.</li>
<li>If the user specifies a negative value for <code>max_page_size</code>, the API
  <strong>must</strong> return a <code>400 Bad Request</code> error.</li>
<li>The service <strong>should</strong> the number of results requested, unless the end of
  the collection is reached.<ul>
<li>However, occasionally this is infeasible, especially within expected time
  limits. In these cases, the service <strong>may</strong> return fewer results than the
  number requested (including zero results), even if not at the end of the
  collection.</li>
</ul>
</li>
</ul>
</li>
<li>Request definitions for collections <strong>should</strong> define a <code>string page_token</code>
  field, allowing users to advance to the next page in the collection.<ul>
<li>If the user changes the <code>max_page_size</code> in a request for subsequent pages,
  the service <strong>must</strong> honor the new page size.</li>
<li>The user is expected to keep all other arguments to the operation request
  the same; if any arguments are different, the API <strong>should</strong> send a
  <code>400 Bad Request</code> error.</li>
</ul>
</li>
<li>The response <strong>must not</strong> be a streaming response.</li>
<li>Services <strong>may</strong> support using page tokens across versions of a service, but
  are not required to do so.</li>
<li>Response definitions for collections <strong>must</strong> define a
  <code>string next_page_token</code> field, providing the user with a page token that may
  be used to retrieve the next page.<ul>
<li>The field containing pagination results <strong>should</strong> be the first field
  specified. It <strong>should</strong> be a repeated field containing a list of resources
  constituting a single page of results.</li>
<li>If the end of the collection has been reached, the <code>next_page_token</code> field
  <strong>must</strong> be empty. This is the <em>only</em> way to communicate
  "end-of-collection" to users.</li>
<li>If the end of the collection has not been reached (or if the API can not
  determine in time), the service <strong>must</strong> provide a <code>next_page_token</code>.</li>
</ul>
</li>
<li>Response definitions <strong>may</strong> include a <code>string next_page_url</code> field
  containing the full URL for the next page.</li>
<li>Response definitions for collections <strong>may</strong> provide an <code>int32 total_size</code>
  field, providing the user with the total number of items in the list.<ul>
<li>This total <strong>may</strong> be an estimate (but the API <strong>should</strong> explicitly
  document that).</li>
</ul>
</li>
</ul>
<h3 id="skipping-results">Skipping results</h3>
<p>The request definition for a paginatied operation <strong>may</strong> define an
<code>int32 skip</code> field to allow the user to skip results.</p>
<p>The <code>skip</code> value <strong>must</strong> refer to the number of individual resources to skip,
not the number of pages.</p>
<p>For example:</p>
<ul>
<li>A request with no page token and a <code>skip</code> value of <code>30</code> returns a single page
  of results starting with the 31st result.</li>
<li>A request with a page token corresponding to the 51st result (because the
  first 50 results were returned on the first page) and a <code>skip</code> value of <code>30</code>
  returns a single page of results starting with the 81st result.</li>
</ul>
<p>If a <code>skip</code> value is provided that causes the cursor to move past the end of
the collection of results, the response <strong>must</strong> be <code>200 OK</code> with an empty
result set, and not provide a <code>next_page_token</code>.</p>
<h3 id="opacity">Opacity</h3>
<p>Page tokens provided by services <strong>must</strong> be opaque (but URL-safe) strings, and
<strong>must not</strong> be user-parseable. This is because if users are able to
deconstruct these, <em>they will do so</em>. This effectively makes the implementation
details of your API's pagination become part of the API surface, and it becomes
impossible to update those details without breaking users.</p>
<p><strong>Warning:</strong> Base-64 encoding an otherwise-transparent page token is <strong>not</strong> a
sufficient obfuscation mechanism.</p>
<p>For page tokens which do not need to be stored in a database, and which do not
contain sensitive data, an API <strong>may</strong> obfuscate the page token by defining an
internal protocol buffer message with any data needed, and send the serialized
proto, base-64 encoded.</p>
<p>Page tokens <strong>must</strong> be limited to providing an indication of where to continue
the pagination process only. They <strong>must not</strong> provide any form of
authorization to the underlying resources, and authorization <strong>must</strong> be
performed on the request as with any other regardless of the presence of a page
token.</p>
<h3 id="expiring-page-tokens">Expiring page tokens</h3>
<p>Many services store page tokens in a database internally. In this situation,
the service <strong>may</strong> expire page tokens a reasonable time after they have been
sent, in order not to needlessly store large amounts of data that is unlikely
to be used. It is not necessary to document this behavior.</p>
<p><strong>Note:</strong> While a reasonable time may vary between services, a good rule of
thumb is three days.</p>
<h3 id="consistency">Consistency</h3>
<p>When discussing pagination, consistency refers to the question of what to do if
the underlying collection is modified while pagination is in progress. The most
common way that this occurs is for a resource to be added or deleted in a place
that the pagination cursor has already passed.</p>
<p>Services <strong>may</strong> choose to be strongly consistent by approximating the
"repeatable read" behavior in databases, and returning exactly the records that
exist at the time that pagination begins.</p>
<h3 id="backwards-compatibility">Backwards compatibility</h3>
<p>Adding pagination to an existing operation is a backwards-incompatible change.
This may seem strange; adding fields to interface definitions is generally
backwards compatible. However, this change is <em>behaviorally</em> incompatible.</p>
<p>Consider a user whose collection has 75 resources, and who has already written
and deployed code. If the API later adds pagination fields, and sets the
default to 50, then that user's code breaks; it was getting all resources, and
now is only getting the first 50 (and does not know to advance pagination).
Even if the API set a higher default limit, such as 100, the user's collection
could grow, and <em>then</em> the code would break.</p>
<p>For this reason, it is important to always add pagination to operations
returning collections <em>up front</em>; they are consistently important, and they can
not be added later without causing problems for existing users.</p>
<p><strong>Warning:</strong> This also entails that, in addition to presenting the pagination
fields, they <strong>must</strong> be <em>actually implemented</em> with a non-infinite default
value. Implementing an in-memory version (which might fetch everything then
paginate) is reasonable for initially-small collections.</p>
<h2 id="implementation">Implementation</h2>
<p>Page tokens <strong>should</strong> be versioned independently of the public API, so that
page tokens can be used with any version of the service.</p>
<p>The simplest form of a page token only requires an offset. However, offsets
pose challenges when a distributed database is introduced, so a more robust
page token needs to store the information needed to find a "logical" position
in the database. The simplest way to do this is to include relevant data from
the last result returned. Primarily, this means the resource ID, but also
includes any other fields from the resource used to sort the results (for the
event where the resource is changed or deleted).</p>
<p>This information is from the resource itself, and therefore might be sensitive.
Sensitive data <strong>must</strong> be encrypted before being used in a page token.
Therefore, the token also includes the date it was created, to allow for the
potential need to rotate the encryption key.</p>
<p>This yields the following interface, which <strong>may</strong> be base64 encoded and used
as a page token:</p>
<div class="highlight language-typescript"><pre><span></span><code><span class="kd">interface</span><span class="w"> </span><span class="nx">PageTokenSecrets</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// The ID of the most recent resource returned.</span><span class="w"></span>
<span class="w">  </span><span class="nx">lastId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Any index data needed, generally 1:1 with the fields used for ordering.</span><span class="w"></span>
<span class="w">  </span><span class="nx">indexData</span><span class="o">:</span><span class="w"> </span><span class="kt">Buffer</span><span class="p">[];</span><span class="w"></span>

<span class="w">  </span><span class="c1">// When this token was minted.</span><span class="w"></span>
<span class="w">  </span><span class="nx">createTime</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><strong>Note:</strong> This section does not preclude alternative page token implementations
provided they conform to the guidelines discussed in this document.</p>
  <footer>
  Except as otherwise noted, the content of this page is licensed under the
  <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons
  Attribution 4.0 License</a>, and code samples are licensed under the
  <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a>.
  <span class="no-print">For details, see <a href="/licensing">content
  licensing</a>.</span>
</footer>
</section>

        </section>
      </main>
      
    </div>
    <script src="//www.gstatic.com/external_hosted/hammerjs/v2_0_2/hammer.min.js"></script>
    <script src="//www.gstatic.com/glue/v22_1/glue-vanilla.min.js"></script>
    <script type="text/javascript">
      const headerElement = document.querySelector('.glue-header');
      if (headerElement) {
        new window.glue.ui.header.Header(headerElement);
      }
    </script>
  </body>
</html>